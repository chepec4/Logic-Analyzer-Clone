name: Build C4 Analyzer VST

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build x86 VST DLL
    runs-on: windows-latest

    steps:
    # 1. Clonado con profundidad total para git checkout
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 

    # 2. Configuración de MSYS2 (Entorno 32-bit puro)
    - name: Set up MSYS2 (MinGW 32-bit)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW32
        update: true
        install: >-
          mingw-w64-i686-toolchain
          make
          mingw-w64-i686-gcc
        path-type: inherit

    # 3. Auditoría Meticulosa (Verifica que libraries esté donde debe)
    - name: Pre-Build Audit
      shell: msys2 {0}
      run: |
        echo "Directorio raíz:"
        ls -F
        echo "Contenido de libraries:"
        ls -F libraries/ || echo "ALERTA: Carpeta libraries no encontrada en la raiz"

    # 4. Compilación (La clave es el working-directory)
    - name: Compile VST Plugin
      shell: msys2 {0}
      working-directory: src
      run: |
        make -f makefile
      env:
        CXX: i686-w64-mingw32-g++

    # 5. Subida del Binario (Busca en la raíz por TARGET := ../)
    - name: Upload C4 Analyzer DLL
      uses: actions/upload-artifact@v4
      with:
        name: C4-Analyzer-v1.0.9-x86
        path: "*.dll"
        if-no-files-found: error
